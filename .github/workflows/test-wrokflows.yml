name: Test Release Workflow
on:
  workflow_dispatch: {}
  
jobs:
  test-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取所有历史记录用于 changelog 生成
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run basic tests (placeholder)
        run: |
          echo "Running basic tests..."
          # 这里可以添加实际的测试命令
          echo "Tests passed!"
        
      - name: Check code quality (placeholder)
        run: |
          echo "Checking code quality..."
          # 这里可以添加 lint 或其他代码质量检查命令
          echo "Code quality check passed!"
        
      - name: Build project
        run: npm run build
        
      - name: List dist files
        run: ls -la dist/

      - name: Generate changelog
        run: |
          echo "## Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- Added automated changelog generation" >> CHANGELOG.md
          echo "- Improved release workflow" >> CHANGELOG.md
          echo "- Various bug fixes and improvements" >> CHANGELOG.md
          
      - name: Read changelog
        id: changelog
        run: |
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
      - name: Test GitHub Release Creation
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: dist/*
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: true